{#
# GNU MediaGoblin -- federated, autonomous media hosting
# Copyright (C) 2011, 2012 MediaGoblin contributors.  See AUTHORS.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#}

{% extends 'mediagoblin/user_pages/media.html' %}

  
{% block mediagoblin_media %}

{% set model_download = request.app.public_store.file_url(
   media.media_files['original']) %}
{% if media.media_data.blender_thumbs %}
{% set perspective_view = request.app.public_store.file_url(
   media.media_files['perspective']) %}
{% set top_view = request.app.public_store.file_url(
   media.media_files['top']) %}
{% set side_view = request.app.public_store.file_url(
   media.media_files['side']) %}
{% set front_view = request.app.public_store.file_url(
   media.media_files['front']) %}
{% endif %}

<style type="text/css">
{% if media.media_data.blender_thumbs %}
#top_view, #side_view, #front_view, #thingy_view {
    display: none;
}
{% else %}
#thingy_view {
    display: block;
}
{% endif %}
.media_image {
    cursor: inherit!important;
}

</style>

{% if media.media_data.file_type == "stl" %}
  <script src="{{ request.staticdirect('/js/extlib/thingiview.js/Three.js') }}"></script>
  <script src="{{ request.staticdirect('/js/extlib/thingiview.js/plane.js') }}"></script>
  <script src="{{ request.staticdirect('/js/extlib/thingiview.js/thingiview.js') }}"></script>
{% endif %}


<script type="text/javascript">
window.show = function (view_id) {
    ids = [
        "perspective",
        "top_view",
        "side_view",
        "front_view",
        "thingy_view",
    ];
    for (var i=0; i<ids.length; i+=1) {
        id = ids[i];
        var view = document.getElementById(id);
        if (view)
          view.style.display = id===view_id ? "block" : "none";
    }
};

window.webgl_renderer = null;
window.show_things = function () {
    document.getElementById("webgl_button").onclick = function () {
        show('thingy_view');
    };
    window.show("thingy_view");
    thingiurlbase = "{{ request.staticdirect('/js/extlib/thingiview.js') }}";
    thingiview = new Thingiview("thingy_view");
    thingiview.setObjectColor('#D00000');
    thingiview.setBackgroundColor('#D0D0D0');
//    thingiview.setGridColor('#000000');
    thingiview.initScene();
    thingiview.loadSTL("{{ model_download }}");
    thingiview.setRotation(false);
    window.webgl_renderer = thingiview.renderer;
    //alert(thingiview.renderer);
    window.render_pixelart();
};

window.printer_dialog = function () {
  dialog = document.getElementById("printer");
  dialog.style.display = "block";
  show("perspective");
}

window.close_printer_dialog = function () {
  dialog = document.getElementById("printer");
  dialog.style.display = "none";
}

window.render_pixelart = function () {
  var w = 64;
  var h = 64;
  var ctx = window.webgl_renderer;
  var arr = false;
  if(!arr){
    arr = new Uint8Array(w * h * 4);
    ctx.readPixels(0, 0, w, h, ctx.RGBA, ctx.UNSIGNED_BYTE, arr);
  }

//  alert(arr[12000]);
}
</script>

{% if media.media_data.blender_thumbs %}
<img 
   id="perspective"
   class="media_image"
   src="{{ perspective_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />
<img 
   id="top_view"
   class="media_image"
   src="{{ top_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />
<img 
   id="side_view"
   class="media_image"
   src="{{ side_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />
<img 
   id="front_view"
   class="media_image"
   src="{{ front_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />

<div 
   id="printer"
   style="display:none"
>
  <div onclick="close_printer_dialog();"
       style="position:absolute;background-color: #eee; opacity:0.7;top:0px;left:0px;width:100%;height:100%" ></div>

  <div style="position:absolute;top:30%;left:28%;">
    <div style="border:1px solid black;border-radius:50px;background-color:black;background-color: rgb(220, 220, 220);padding:50px; z-index:-10;" >
    <h2>Impressão 3D</h2>
    Escolha uma impressora para enviar esta peça para impressão:<br/><br/><br/>
      <ul>
        <li><a class="button_action" onclick="">Gatinho de Beco</a> <em>R$12,00</em> - São Paulo, SP</li>
        <li><a class="button_action" onclick="">Coisinha Automática</a> <em>R$ 11,50</em> - Campinas, SP</li>
        <li><a class="button_action" onclick="">Bolinho de Chuva</a> <em>R$ 17,00</em> - Salvador, BA</li>
        <li><a class="button_action" onclick="">Tails</a> <em>R$ 7,00</em> - Parati, RJ</li>
        <li><a class="button_action" onclick="">Bowser</a> <em>R$ 13,75</em> - São José dos Campos, SP</li>
      </ul>
    </div>
  </div>
</div>
{% endif %}

<div id="thingy_view" style="width:640px;height:640px;"></div>


<div style="padding: 4px;">
{% if media.media_data.blender_thumbs %}
  <a class="button_action" onclick="show('perspective');"
     title="{%- trans %}Toggle Rotate{% endtrans -%}">
    {%- trans %}Perspective{% endtrans -%}
  </a>
  <a class="button_action" onclick="show('front_view');"
     title="{%- trans %}Front{% endtrans -%}">
    {%- trans %}Front{% endtrans -%}
  </a>
  <a class="button_action" onclick="show('top_view');"
     title="{%- trans %}Top{% endtrans -%}">
    {%- trans %}Top{% endtrans -%}
  </a>
  <a class="button_action" onclick="show('side_view');"
     title="{%- trans %}Side{% endtrans -%}">
    {%- trans %}Side{% endtrans -%}
  </a>

{% else %}
<script>
//since we don't have thumbnains, we'll automatically start the WebGL model viewer:
show_things();
show('thingy_view');
</script>
{% endif %}

{% if media.media_data.file_type == "stl" %}
  <a id="webgl_button" class="button_action"
     onclick="show_things();"
     title="{%- trans %}WebGL{% endtrans -%}">
    {%- trans %}WebGL{% endtrans -%}
  </a>
{% endif %}

  <a class="button_action" onclick="printer_dialog();"
     title="{%- trans %}Print{% endtrans -%}"
     style="float:right;">
    {%- trans %}Print this!{% endtrans -%}
  </a>

  <a class="button_action" href="{{ model_download }}"
     title="{%- trans %}Download model{% endtrans -%}"
     style="float:right;">
    {%- trans %}Download model{% endtrans -%}
  </a>
</div>


{% endblock %}

{% set ABS_seconds = media.media_data.ABS_total_duration %}
{% set ABS_minutes = ((ABS_seconds/60)%60)|int %}
{% set ABS_hours = (ABS_seconds/3600)|int %}

{% set PLA_seconds = media.media_data.PLA_total_duration %}
{% set PLA_minutes = ((PLA_seconds/60)%60)|int %}
{% set PLA_hours = (PLA_seconds/3600)|int %}
{% set ABS_gcode_download = request.app.public_store.file_url(
   media.media_files['ABS_gcode']) %}
{% set PLA_gcode_download = request.app.public_store.file_url(
   media.media_files['PLA_gcode']) %}

{% block mediagoblin_sidebar %}
<h3>{% trans %}File Format{% endtrans %}</h3>
<p>{{ media.media_data.file_type }}</p>
<h3>{% trans %}Object Height{% endtrans %}</h3>
<p>~{{ media.media_data.height|int }} mm</p>

<h2>ABS</h2>
<a class="button_action" href="{{ ABS_gcode_download }}"
   title="{%- trans %}Gcode{% endtrans -%}">
  {%- trans %}G-Code{% endtrans -%}
</a>
<p>{% trans %}Filament extruded{% endtrans %}: ~{{ media.media_data.ABS_filament_length|float }} mm</p>
<p>{% trans %}Volume of plastic{% endtrans %}: ~{{ media.media_data.ABS_plastic_volume|float }} cm3</p>
<p>{% trans %}Weigth{% endtrans %}: ~{{ media.media_data.ABS_plastic_volume*1.04|float }} g</p>
<p>layers: {{ media.media_data.ABS_layer_count|int }}</p>
<p>estimated print time: {{ ABS_hours }}h {{ ABS_minutes%60 }}min</p>

<h2>PLA</h2>
<a class="button_action" href="{{ PLA_gcode_download }}"
   title="{%- trans %}Gcode{% endtrans -%}">
  {%- trans %}G-Code{% endtrans -%}
</a>
<p>{% trans %}Filament extruded{% endtrans %}: ~{{ media.media_data.PLA_filament_length|float }} mm</p>
<p>{% trans %}Volume of plastic{% endtrans %}: ~{{ media.media_data.PLA_plastic_volume|float }} cm3</p>
<p>{% trans %}Weigth{% endtrans %}: ~{{ media.media_data.PLA_plastic_volume*1.25|float }} g</p>
<p>layers: {{ media.media_data.PLA_layer_count|int }}</p>
<p>estimated print time: {{ PLA_hours }}h {{ PLA_minutes%60 }}min</p>
{% endblock %}
