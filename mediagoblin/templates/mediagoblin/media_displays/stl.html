{#
# GNU MediaGoblin -- federated, autonomous media hosting
# Copyright (C) 2011, 2012 MediaGoblin contributors.  See AUTHORS.
#
# This program is free software: you can redistribute it and/or modify
# it under the terms of the GNU Affero General Public License as published by
# the Free Software Foundation, either version 3 of the License, or
# (at your option) any later version.
#
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU Affero General Public License for more details.
#
# You should have received a copy of the GNU Affero General Public License
# along with this program.  If not, see <http://www.gnu.org/licenses/>.
#}

{% extends 'mediagoblin/user_pages/media.html' %}

  
{% block mediagoblin_media %}

{% set model_download = request.app.public_store.file_url(
   media.media_files['original']) %}
{% if media.media_data.blender_thumbs %}
{% set perspective_view = request.app.public_store.file_url(
   media.media_files['perspective']) %}
{% set top_view = request.app.public_store.file_url(
   media.media_files['top']) %}
{% set side_view = request.app.public_store.file_url(
   media.media_files['side']) %}
{% set front_view = request.app.public_store.file_url(
   media.media_files['front']) %}
{% endif %}

<style type="text/css">
{% if media.media_data.blender_thumbs %}
#top_view, #side_view, #front_view, #thingy_view {
    display: none;
}
{% else %}
#thingy_view {
    display: block;
}
{% endif %}
.media_image {
    cursor: inherit!important;
}

</style>

{% if media.media_data.file_type == "stl" %}
  <script src="{{ request.staticdirect('/js/extlib/thingiview.js/Three.js') }}"></script>
  <script src="{{ request.staticdirect('/js/extlib/thingiview.js/plane.js') }}"></script>
  <script src="{{ request.staticdirect('/js/extlib/thingiview.js/thingiview.js') }}"></script>
{% endif %}


<script type="text/javascript">
window.show = function (view_id) {
    ids = [
        "perspective",
        "top_view",
        "side_view",
        "front_view",
        "thingy_view",
    ];
    for (var i=0; i<ids.length; i+=1) {
        id = ids[i];
        var view = document.getElementById(id);
        if (view)
          view.style.display = id===view_id ? "block" : "none";
    }
};

window.context2d = null;
window.pixelart_size = 500;

window.show_things = function () {
    document.getElementById("webgl_button").onclick = function () {
        show('thingy_view');
    };
    window.show("thingy_view");
    thingiurlbase = "{{ request.staticdirect('/js/extlib/thingiview.js') }}";
    thingiview = new Thingiview("thingy_view");
    thingiview.setObjectColor('#D00000');
    thingiview.setBackgroundColor('#D0D0D0');
    thingiview.initScene();
    thingiview.loadSTL("{{ model_download }}");
    thingiview.setRotation(true);

    window.thingiview = thingiview;

    var canvas2d = document.createElement("canvas");
    canvas2d.setAttribute("style", "height:" + window.pixelart_size + "px;width:" + (window.pixelart_size*64/64.0) + "px; position:absolute;top:0px;left:0px;");
    window.context2d = canvas2d.getContext("2d", { antialias: false });
    document.body.appendChild(canvas2d);

    window.setInterval(window.pixel_art, 200);
};

window.printer_dialog = function () {
  dialog = document.getElementById("printer");
  dialog.style.display = "block";
  show("perspective");
}

window.close_printer_dialog = function () {
  dialog = document.getElementById("printer");
  dialog.style.display = "none";
}

var maxc=0;

window.pixel_art = function (){
    var a = window.thingiview.renderPixelArt();
    var ctx = window.context2d;
    var border = 0;
//    var size = (window.pixelart_size*0.8)/64.0 - border;
    var size = 4;

    for (var x=0; x<64; x++){
      for (var y=0; y<64; y++){
        var color = (a[4*(x+64*y)] + a[4*(x+64*y) + 1] + a[4*(x+64*y) + 2])/3;

        if (color > maxc) maxc = color;
        var code = ["0","1","2","3","4","5","6","7","8","9","a","b","c","d","e","f"][Math.floor(16*color/80)];

        ctx.fillStyle = "#0" + code + code;
        ctx.fillRect((size+border)*x, (size+border)*(63-y), size, size);
      }
    }
}

window.printmaxc = function(){
  document.getElementById("max").innerHTML = maxc;
}

</script>
<div onclick="window.printmaxc();">
Print Max Color
</div>

Max Color Value:
<div id="max">
</div>

{% if media.media_data.blender_thumbs %}
<img 
   id="perspective"
   class="media_image"
   src="{{ perspective_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />
<img 
   id="top_view"
   class="media_image"
   src="{{ top_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />
<img 
   id="side_view"
   class="media_image"
   src="{{ side_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />
<img 
   id="front_view"
   class="media_image"
   src="{{ front_view }}"
   alt="{% trans media_title=media.title -%}
        Image for {{ media_title }}{% endtrans %}" />

<div 
   id="printer"
   style="display:none"
>
  <div onclick="close_printer_dialog();"
       style="position:absolute;background-color: #511; opacity:0.7;top:0px;left:0px;width:100%;height:100%" ></div>

  <div style="position:absolute;top:30%;left:28%;">
    <div style="border-radius:20px;background-color:black;background-color: rgba(50, 10, 10, 1);padding:50px" >
    <h2>Impressão 3D</h2>
    Escolha uma impressora para enviar esta peça para impressão:<br/><br/><br/>
      <ul>
        <li><a class="button_action" onclick="">Gatinho de Beco</a></li>
        <li><a class="button_action" onclick="">Coisinha Automática</a></li>
        <li><a class="button_action" onclick="">Bolinho de Chuva</a></li>
        <li><a class="button_action" onclick="">Tails</a></li>
        <li><a class="button_action" onclick="">Bowser</a></li>
      </ul>
    </div>
  </div>
</div>
{% endif %}

<div id="thingy_view" style="width:64px;height:64px;"></div>


<div style="padding: 4px;">
{% if media.media_data.blender_thumbs %}
  <a class="button_action" onclick="show('perspective');"
     title="{%- trans %}Toggle Rotate{% endtrans -%}">
    {%- trans %}Perspective{% endtrans -%}
  </a>
  <a class="button_action" onclick="show('front_view');"
     title="{%- trans %}Front{% endtrans -%}">
    {%- trans %}Front{% endtrans -%}
  </a>
  <a class="button_action" onclick="show('top_view');"
     title="{%- trans %}Top{% endtrans -%}">
    {%- trans %}Top{% endtrans -%}
  </a>
  <a class="button_action" onclick="show('side_view');"
     title="{%- trans %}Side{% endtrans -%}">
    {%- trans %}Side{% endtrans -%}
  </a>

{% else %}
<script>
//since we don't have thumbnains, we'll automatically start the WebGL model viewer:
show_things();
show('thingy_view');
</script>
{% endif %}

{% if media.media_data.file_type == "stl" %}
  <a id="webgl_button" class="button_action"
     onclick="show_things();"
     title="{%- trans %}WebGL{% endtrans -%}">
    {%- trans %}WebGL{% endtrans -%}
  </a>
{% endif %}

  <a class="button_action" onclick="printer_dialog();"
     title="{%- trans %}Print{% endtrans -%}"
     style="float:right;">
    {%- trans %}Print this!{% endtrans -%}
  </a>

  <a class="button_action" href="{{ model_download }}"
     title="{%- trans %}Download model{% endtrans -%}"
     style="float:right;">
    {%- trans %}Download model{% endtrans -%}
  </a>
</div>


{% endblock %}

{% set ABS_seconds = media.media_data.ABS_total_duration %}
{% set ABS_minutes = ((ABS_seconds/60)%60)|int %}
{% set ABS_hours = (ABS_seconds/3600)|int %}

{% set PLA_seconds = media.media_data.PLA_total_duration %}
{% set PLA_minutes = ((PLA_seconds/60)%60)|int %}
{% set PLA_hours = (PLA_seconds/3600)|int %}
{% set ABS_gcode_download = request.app.public_store.file_url(
   media.media_files['ABS_gcode']) %}
{% set PLA_gcode_download = request.app.public_store.file_url(
   media.media_files['PLA_gcode']) %}

{% block mediagoblin_sidebar %}
<h3>{% trans %}File Format{% endtrans %}</h3>
<p>{{ media.media_data.file_type }}</p>
<h3>{% trans %}Object Height{% endtrans %}</h3>
<p>~{{ media.media_data.height|int }} mm</p>

<h2>ABS</h2>
<a class="button_action" href="{{ ABS_gcode_download }}"
   title="{%- trans %}Gcode{% endtrans -%}">
  {%- trans %}G-Code{% endtrans -%}
</a>
<p>{% trans %}Filament extruded{% endtrans %}: ~{{ media.media_data.ABS_filament_length|float }} mm</p>
<p>{% trans %}Volume of plastic{% endtrans %}: ~{{ media.media_data.ABS_plastic_volume|float }} cm3</p>
<p>{% trans %}Weigth{% endtrans %}: ~{{ media.media_data.ABS_plastic_volume*1.04|float }} g</p>
<p>layers: {{ media.media_data.ABS_layer_count|int }}</p>
<p>estimated print time: {{ ABS_hours }}h {{ ABS_minutes%60 }}min</p>

<h2>PLA</h2>
<a class="button_action" href="{{ PLA_gcode_download }}"
   title="{%- trans %}Gcode{% endtrans -%}">
  {%- trans %}G-Code{% endtrans -%}
</a>
<p>{% trans %}Filament extruded{% endtrans %}: ~{{ media.media_data.PLA_filament_length|float }} mm</p>
<p>{% trans %}Volume of plastic{% endtrans %}: ~{{ media.media_data.PLA_plastic_volume|float }} cm3</p>
<p>{% trans %}Weigth{% endtrans %}: ~{{ media.media_data.PLA_plastic_volume*1.25|float }} g</p>
<p>layers: {{ media.media_data.PLA_layer_count|int }}</p>
<p>estimated print time: {{ PLA_hours }}h {{ PLA_minutes%60 }}min</p>
{% endblock %}
